/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var x=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var j=Object.prototype.hasOwnProperty;var z=(o,s)=>{for(var e in s)x(o,e,{get:s[e],enumerable:!0})},Y=(o,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let n of U(s))!j.call(o,n)&&n!==e&&x(o,n,{get:()=>s[n],enumerable:!(t=_(s,n))||t.enumerable});return o};var J=o=>Y(x({},"__esModule",{value:!0}),o);var Z={};z(Z,{default:()=>M});module.exports=J(Z);var v=require("obsidian");var O=require("child_process"),N=require("util"),q=(0,N.promisify)(O.exec),y=class{constructor(s){this.qmdPath=s}setPath(s){this.qmdPath=s}async search(s,e={}){let t=this.buildArgs("search",s,e);return{...await this.execute(t),mode:"search"}}async vsearch(s,e={}){let t=this.buildArgs("vsearch",s,e);return{...await this.execute(t),mode:"vsearch"}}async query(s,e={}){let t=this.buildArgs("query",s,e);return{...await this.execute(t),mode:"query"}}async get(s){let e=this.escapeShellArg(s),{stdout:t}=await q(`${this.qmdPath} get ${e} --json`,{maxBuffer:10*1024*1024});return JSON.parse(t)}async status(){let{stdout:s}=await q(`${this.qmdPath} status --json`,{maxBuffer:1048576});return JSON.parse(s)}async testConnection(){try{return{ok:!0,status:await this.status()}}catch(s){return{ok:!1,error:s instanceof Error?s.message:String(s)}}}async getCollections(){try{return(await this.status()).collections.map(e=>e.name)}catch(s){return[]}}buildArgs(s,e,t){let n=this.escapeShellArg(e),i=[s,n,"--json"];return t.collection&&i.push("-c",t.collection),t.limit&&i.push("-n",String(t.limit)),t.minScore&&i.push("--min-score",String(t.minScore)),t.full&&i.push("--full"),i.join(" ")}async execute(s){try{let{stdout:e,stderr:t}=await q(`${this.qmdPath} ${s}`,{maxBuffer:10485760,timeout:3e4});t&&console.warn("[QMD]",t);let n=JSON.parse(e);return this.normalizeResponse(n)}catch(e){throw this.handleError(e)}}normalizeResponse(s){return{results:(s.results||s.documents||[]).map(t=>{var n;return{docid:t.docid||t.id||"",path:t.path||t.file||"",absolutePath:t.absolutePath||t.absolute_path||t.path||"",title:t.title||this.extractTitleFromPath(t.path||""),score:typeof t.score=="number"?t.score:parseFloat(t.score)||0,snippet:t.snippet||((n=t.content)==null?void 0:n.substring(0,200))||"",context:t.context||void 0,collection:t.collection||"default"}}),query:s.query||"",mode:s.mode||"search",elapsed:s.elapsed||0}}extractTitleFromPath(s){return(s.split("/").pop()||s).replace(/\.md$/,"")}escapeShellArg(s){return`"${s.replace(/"/g,'\\"')}"`}handleError(s){var t;let e=s;return e.code==="ENOENT"?{type:"connection",message:"qmd not found at the specified path",details:`Path: ${this.qmdPath}`}:e.killed?{type:"timeout",message:"Search timed out",details:"Try a simpler query or reduce result count"}:(t=e.message)!=null&&t.includes("JSON")?{type:"parse",message:"Failed to parse qmd response",details:e.message}:{type:"unknown",message:e.message||"Unknown error",details:String(s)}}};var g=class{constructor(s=300*1e3){this.ttlMs=s;this.cache=new Map;this.cleanupInterval=null;this.cleanupInterval=setInterval(()=>this.cleanup(),60*1e3)}get(s){let e=this.cache.get(s);return e?Date.now()>e.expires?(this.cache.delete(s),null):e.data:null}set(s,e,t){this.cache.set(s,{data:e,expires:Date.now()+(t!=null?t:this.ttlMs)})}has(s){return this.get(s)!==null}delete(s){return this.cache.delete(s)}clear(){this.cache.clear()}size(){return this.cache.size}cleanup(){let s=Date.now();for(let[e,t]of this.cache)s>t.expires&&this.cache.delete(e)}touch(s){let e=this.cache.get(s);return e?(e.expires=Date.now()+this.ttlMs,!0):!1}destroy(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.cache.clear()}};var P=class{constructor(s,e){this.apiKey=s;this.model=e}async chat(s){let e=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({model:this.model,messages:s,max_tokens:2048})});if(!e.ok){let n=await e.text();throw new Error(`OpenAI API error: ${n}`)}return(await e.json()).choices[0].message.content}},E=class{constructor(s,e){this.apiKey=s;this.model=e}async chat(s){let e=s.find(a=>a.role==="system"),t=s.filter(a=>a.role!=="system"),n=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:this.model,max_tokens:2048,system:e==null?void 0:e.content,messages:t.map(a=>({role:a.role,content:a.content}))})});if(!n.ok){let a=await n.text();throw new Error(`Anthropic API error: ${a}`)}return(await n.json()).content[0].text}},T=class{constructor(s,e){this.apiKey=s;this.model=e}async chat(s){let e=s.find(l=>l.role==="system"),i={contents:s.filter(l=>l.role!=="system").map(l=>({role:l.role==="assistant"?"model":"user",parts:[{text:l.content}]}))};e&&(i.systemInstruction={parts:[{text:e.content}]}),i.generationConfig={maxOutputTokens:2048,temperature:.7};let a=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${this.model}:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!a.ok){let l=await a.text();throw new Error(`Gemini API error: ${l}`)}let c=await a.json();if(!c.candidates||c.candidates.length===0)throw new Error("Gemini returned no response");return c.candidates[0].content.parts[0].text}},D=class{constructor(s,e){this.baseUrl=s;this.model=e}async chat(s){let e=await fetch(`${this.baseUrl}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:this.model,messages:s,stream:!1})});if(!e.ok){let n=await e.text();throw new Error(`Ollama API error: ${n}`)}return(await e.json()).message.content}};function L(o){switch(o.llmProvider){case"openai":{if(!o.openaiApiKey)return null;let s=o.useOpenaiCustomModel&&o.openaiCustomModel?o.openaiCustomModel:o.openaiModel;return new P(o.openaiApiKey,s)}case"anthropic":{if(!o.anthropicApiKey)return null;let s=o.useAnthropicCustomModel&&o.anthropicCustomModel?o.anthropicCustomModel:o.anthropicModel;return new E(o.anthropicApiKey,s)}case"gemini":{if(!o.geminiApiKey)return null;let s=o.useGeminiCustomModel&&o.geminiCustomModel?o.geminiCustomModel:o.geminiModel;return new T(o.geminiApiKey,s)}case"ollama":return new D(o.ollamaUrl,o.ollamaModel);default:return null}}var h=require("obsidian"),k=require("child_process"),$=require("util"),I=(0,$.promisify)(k.exec),f=class{constructor(s,e,t="off",n=10){this.intervalId=null;this.status={lastSync:null,isRunning:!1,pendingFiles:0,error:null};this.pendingChanges=new Set;this.app=s,this.qmdPath=e,this.vaultPath=s.vault.adapter.basePath,this.collectionName=s.vault.getName(),this.mode=t,this.intervalMinutes=n,this.debouncedSync=(0,h.debounce)(()=>this.syncPendingChanges(),5e3,!0)}setStatusCallback(s){this.onStatusChange=s}updateStatus(s){var e;this.status={...this.status,...s},(e=this.onStatusChange)==null||e.call(this,this.status)}async start(){this.stop(),this.mode!=="off"&&(this.mode==="on-startup"&&await this.fullSync(),this.mode==="scheduled"&&this.intervalMinutes>0&&(this.intervalId=setInterval(()=>this.fullSync(),this.intervalMinutes*60*1e3)))}stop(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null)}setMode(s){this.mode=s,this.start()}setInterval(s){this.intervalMinutes=s,this.mode==="scheduled"&&this.start()}setQmdPath(s){this.qmdPath=s}onFileChange(s){this.mode==="on-save"&&s instanceof h.TFile&&s.extension==="md"&&(this.pendingChanges.add(s.path),this.updateStatus({pendingFiles:this.pendingChanges.size}),this.debouncedSync())}onFileDelete(s){this.mode==="on-save"&&(this.pendingChanges.add("__deleted__"),this.debouncedSync())}async syncPendingChanges(){this.status.isRunning||this.pendingChanges.size!==0&&(this.pendingChanges.clear(),await this.incrementalSync())}async incrementalSync(){if(!this.status.isRunning){this.updateStatus({isRunning:!0,error:null});try{await I(`"${this.qmdPath}" update`,{timeout:12e4}),this.updateStatus({isRunning:!1,lastSync:new Date,pendingFiles:0})}catch(s){let e=s instanceof Error?s.message:String(s);this.updateStatus({isRunning:!1,error:e})}}}async fullSync(s=!1){if(!this.status.isRunning){this.updateStatus({isRunning:!0,error:null}),s&&new h.Notice("QMD: Starting sync...");try{await I(`"${this.qmdPath}" collection add "${this.vaultPath}" --name "${this.collectionName}" 2>/dev/null || "${this.qmdPath}" update`,{timeout:3e5}),this.updateStatus({lastSync:new Date}),s&&new h.Notice("QMD: Index updated"),await this.generateEmbeddings(s),this.updateStatus({isRunning:!1,pendingFiles:0})}catch(e){let t=e instanceof Error?e.message:String(e);this.updateStatus({isRunning:!1,error:t}),s&&new h.Notice(`QMD sync failed: ${t}`)}}}async generateEmbeddings(s=!1){try{let{stdout:e}=await I(`"${this.qmdPath}" status`,{timeout:3e4});e.includes("need embedding")&&(s&&new h.Notice("QMD: Generating embeddings (background)..."),(0,k.exec)(`"${this.qmdPath}" embed`,{timeout:18e5}))}catch(e){}}async manualSync(){await this.fullSync(!0)}getStatus(){return{...this.status}}destroy(){this.stop()}};var d=require("obsidian");function S(o,s){let e=null;return function(...t){e&&clearTimeout(e),e=setTimeout(()=>{o.apply(this,t),e=null},s)}}var p="qmd-sidebar",w=class extends d.ItemView{constructor(e,t){super(e);this.searchInput=null;this.resultsContainer=null;this.relatedContainer=null;this.chatContainer=null;this.chatInput=null;this.chatMessages=[];this.currentMode="query";this.isSearching=!1;this.currentFile=null;this.plugin=t,this.currentMode=t.settings.defaultSearchMode}getViewType(){return p}getDisplayText(){return"QMD Search"}getIcon(){return"search"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("qmd-sidebar"),this.renderHeader(e),this.renderSearchPanel(e),this.renderResultsPanel(e),this.renderChatPanel(e),this.renderRelatedPanel(e)}async onClose(){this.searchInput=null,this.resultsContainer=null,this.relatedContainer=null,this.chatContainer=null,this.chatInput=null}renderHeader(e){let t=e.createDiv("qmd-header");t.createEl("h4",{text:"QMD Search"}).addClass("qmd-title");let i=t.createEl("button",{cls:"qmd-settings-btn clickable-icon"});(0,d.setIcon)(i,"settings"),i.addEventListener("click",()=>{this.app.setting.open(),this.app.setting.openTabById("qmd-ragidian")})}renderSearchPanel(e){let t=e.createDiv("qmd-search-panel"),n=t.createDiv("qmd-input-wrapper");this.searchInput=n.createEl("input",{type:"text",placeholder:"Search your notes...",cls:"qmd-search-input"});let i=n.createEl("button",{cls:"qmd-search-btn clickable-icon"});(0,d.setIcon)(i,"search"),i.addEventListener("click",()=>this.executeSearch()),this.searchInput.addEventListener("keydown",m=>{m.key==="Enter"&&this.executeSearch()});let a=S(()=>this.executeSearch(),300);this.searchInput.addEventListener("input",a);let c=t.createDiv("qmd-mode-selector");this.renderModeButtons(c);let l=t.createDiv("qmd-collection-selector");this.renderCollectionDropdown(l)}renderModeButtons(e){[{id:"search",label:"Keyword",icon:"file-text"},{id:"vsearch",label:"Semantic",icon:"brain"},{id:"query",label:"Hybrid",icon:"sparkles"}].forEach(n=>{let i=e.createEl("button",{text:n.label,cls:`qmd-mode-btn ${n.id===this.currentMode?"active":""}`});i.dataset.mode=n.id,i.addEventListener("click",()=>{var a;e.querySelectorAll(".qmd-mode-btn").forEach(c=>c.removeClass("active")),i.addClass("active"),this.currentMode=n.id,(a=this.searchInput)!=null&&a.value&&this.executeSearch()})})}async renderCollectionDropdown(e){let t=e.createEl("span",{text:"Collection: ",cls:"qmd-collection-label"}),n=e.createEl("select",{cls:"qmd-collection-select"});n.createEl("option",{value:"",text:"All"});try{(await this.plugin.qmdClient.getCollections()).forEach(a=>{n.createEl("option",{value:a,text:a})})}catch(i){console.warn("Failed to load collections:",i)}}renderResultsPanel(e){let t=e.createDiv("qmd-results-panel"),n=t.createDiv("qmd-results-header");n.createEl("span",{text:"Results",cls:"qmd-results-title"});let i=n.createEl("button",{cls:"qmd-refresh-btn clickable-icon"});(0,d.setIcon)(i,"refresh-cw"),i.addEventListener("click",()=>this.executeSearch()),this.resultsContainer=t.createDiv("qmd-results-list"),this.resultsContainer.createEl("div",{text:"Enter a search query above",cls:"qmd-results-empty"})}renderChatPanel(e){if(this.plugin.settings.llmProvider==="none")return;let t=e.createDiv("qmd-chat-panel"),n=t.createDiv("qmd-chat-header");n.createEl("span",{text:"RAG Chat",cls:"qmd-chat-title"});let i=n.createEl("button",{cls:"qmd-collapse-btn clickable-icon"});(0,d.setIcon)(i,"chevron-down"),i.addEventListener("click",()=>{t.toggleClass("collapsed",!t.hasClass("collapsed")),(0,d.setIcon)(i,t.hasClass("collapsed")?"chevron-right":"chevron-down")}),this.chatContainer=t.createDiv("qmd-chat-messages");let a=t.createDiv("qmd-chat-input-wrapper");this.chatInput=a.createEl("textarea",{placeholder:"Ask a question about your notes...",cls:"qmd-chat-input"});let c=a.createEl("button",{cls:"qmd-chat-send clickable-icon"});(0,d.setIcon)(c,"send"),c.addEventListener("click",()=>this.sendChatMessage()),this.chatInput.addEventListener("keydown",l=>{l.key==="Enter"&&!l.shiftKey&&(l.preventDefault(),this.sendChatMessage())})}renderRelatedPanel(e){let t=e.createDiv("qmd-related-panel"),n=t.createDiv("qmd-related-header");n.createEl("span",{text:"Related Documents",cls:"qmd-related-title"});let i=n.createEl("button",{cls:"qmd-collapse-btn clickable-icon"});(0,d.setIcon)(i,"chevron-down"),i.addEventListener("click",()=>{t.toggleClass("collapsed",!t.hasClass("collapsed")),(0,d.setIcon)(i,t.hasClass("collapsed")?"chevron-right":"chevron-down")}),this.relatedContainer=t.createDiv("qmd-related-list"),this.relatedContainer.createEl("div",{text:"Open a note to see related documents",cls:"qmd-related-empty"})}async executeSearch(){var t,n;let e=(n=(t=this.searchInput)==null?void 0:t.value)==null?void 0:n.trim();if(!(!e||this.isSearching)){this.isSearching=!0,this.showSearchLoading();try{let i=this.containerEl.querySelector(".qmd-collection-select"),a=(i==null?void 0:i.value)||void 0,c,l={collection:a,limit:this.plugin.settings.defaultLimit,minScore:this.plugin.settings.minScore};switch(this.currentMode){case"search":c=await this.plugin.qmdClient.search(e,l);break;case"vsearch":c=await this.plugin.qmdClient.vsearch(e,l);break;case"query":default:c=await this.plugin.qmdClient.query(e,l);break}this.renderResults(c)}catch(i){this.showSearchError(i instanceof Error?i.message:String(i))}finally{this.isSearching=!1}}}showSearchLoading(){if(!this.resultsContainer)return;this.resultsContainer.empty(),this.resultsContainer.createDiv("qmd-loading").createEl("span",{text:"Searching...",cls:"qmd-loading-text"})}showSearchError(e){if(!this.resultsContainer)return;this.resultsContainer.empty();let t=this.resultsContainer.createDiv("qmd-error");(0,d.setIcon)(t.createSpan(),"alert-circle"),t.createEl("span",{text:e,cls:"qmd-error-text"})}renderResults(e){if(!this.resultsContainer)return;if(this.resultsContainer.empty(),e.results.length===0){this.resultsContainer.createEl("div",{text:"No results found",cls:"qmd-results-empty"});return}this.resultsContainer.createDiv("qmd-results-count").createEl("span",{text:`${e.results.length} results (${e.elapsed}ms)`}),e.results.forEach(n=>{this.renderResultItem(this.resultsContainer,n)})}renderResultItem(e,t){let n=e.createDiv("qmd-result-card");n.addEventListener("click",l=>{let m=l.metaKey||l.ctrlKey;this.openDocument(t,m)});let i=n.createDiv("qmd-result-header");(0,d.setIcon)(i.createSpan("qmd-result-icon"),"file-text"),i.createEl("span",{text:t.title,cls:"qmd-result-title"});let a=Math.round(t.score*100),c=a>=70?"high":a>=40?"medium":"low";i.createEl("span",{text:`${a}%`,cls:`qmd-result-score qmd-score-${c}`}),t.snippet&&n.createEl("div",{text:t.snippet.substring(0,150)+(t.snippet.length>150?"...":""),cls:"qmd-result-snippet"}),t.context&&n.createEl("div",{text:t.context,cls:"qmd-result-context"})}openDocument(e,t){let n=e.path;t?this.app.workspace.openLinkText(n,"","tab"):this.app.workspace.openLinkText(n,"",!1)}async updateRelatedDocuments(e){if(!this.plugin.settings.enableRelated||!this.relatedContainer||e===this.currentFile)return;this.currentFile=e;let t=e.path,n=this.plugin.relatedCache.get(t);if(n){this.renderRelatedResults(n);return}this.relatedContainer.empty(),this.relatedContainer.createEl("div",{text:"Loading...",cls:"qmd-related-loading"});try{let i=await this.app.vault.cachedRead(e),a=`${e.basename} ${i.substring(0,300)}`,c=await this.plugin.qmdClient.vsearch(a,{limit:this.plugin.settings.relatedLimit+1,minScore:.3}),l=c.results.filter(K=>K.path!==e.path),m={...c,results:l.slice(0,this.plugin.settings.relatedLimit)};this.plugin.relatedCache.set(t,m),this.renderRelatedResults(m)}catch(i){this.relatedContainer.empty(),this.relatedContainer.createEl("div",{text:"Failed to load related documents",cls:"qmd-related-error"})}}renderRelatedResults(e){if(this.relatedContainer){if(this.relatedContainer.empty(),e.results.length===0){this.relatedContainer.createEl("div",{text:"No related documents found",cls:"qmd-related-empty"});return}e.results.forEach(t=>{let n=this.relatedContainer.createDiv("qmd-related-item");n.addEventListener("click",()=>this.openDocument(t,!1)),n.createEl("span",{text:t.title,cls:"qmd-related-title"});let i=Math.round(t.score*100);n.createEl("span",{text:`${i}%`,cls:"qmd-related-score"})})}}async sendChatMessage(){var t,n;let e=(n=(t=this.chatInput)==null?void 0:t.value)==null?void 0:n.trim();if(!(!e||!this.chatContainer)){this.chatInput.value="",this.addChatMessage({role:"user",content:e}),this.addChatMessage({role:"assistant",content:"Thinking..."});try{let i=await this.plugin.qmdClient.query(e,{limit:this.plugin.settings.ragContextLimit,minScore:.2}),a=i.results.map(l=>`### ${l.title}
${l.snippet}`).join(`

`),c=await this.plugin.chat(e,a,i.results);this.chatMessages.pop(),this.addChatMessage({role:"assistant",content:c,sources:i.results})}catch(i){this.chatMessages.pop(),this.addChatMessage({role:"assistant",content:`Error: ${i instanceof Error?i.message:String(i)}`})}}}addChatMessage(e){if(!this.chatContainer)return;if(this.chatMessages.push(e),e.content==="Thinking..."){let a=this.chatContainer.querySelector(".qmd-chat-thinking");a&&a.remove()}let t=this.chatContainer.createDiv(`qmd-chat-message qmd-chat-${e.role}`),n=e.role==="user"?"user":"bot";if((0,d.setIcon)(t.createSpan("qmd-chat-icon"),n),t.createDiv("qmd-chat-content").setText(e.content),e.content==="Thinking..."&&t.addClass("qmd-chat-thinking"),e.sources&&e.sources.length>0){let a=t.createDiv("qmd-chat-sources");a.createEl("span",{text:"Sources: ",cls:"qmd-chat-sources-label"}),e.sources.forEach(c=>{a.createEl("a",{text:c.title,cls:"qmd-chat-source-link"}).addEventListener("click",m=>{m.preventDefault(),this.openDocument(c,!1)})})}this.chatContainer.scrollTop=this.chatContainer.scrollHeight}};var r=require("obsidian");var A={qmdPath:"",syncMode:"on-startup",syncIntervalMinutes:10,defaultSearchMode:"query",defaultLimit:10,minScore:.3,enableRelated:!0,relatedLimit:5,relatedCacheTTL:5,relatedDebounceMs:2e3,llmProvider:"none",openaiApiKey:"",openaiModel:"gpt-5.2",openaiCustomModel:"",useOpenaiCustomModel:!1,anthropicApiKey:"",anthropicModel:"claude-opus-4-6-20260205",anthropicCustomModel:"",useAnthropicCustomModel:!1,geminiApiKey:"",geminiModel:"gemini-2.5-flash",geminiCustomModel:"",useGeminiCustomModel:!1,ollamaUrl:"http://localhost:11434",ollamaModel:"llama3.2",ragContextLimit:5,ragSystemPrompt:`You are a helpful assistant that answers questions based on the user's notes.
Use the provided documents as context. If the answer isn't in the context, say so.
Always cite your sources using [[document-name]] format.`},H=[{value:"gpt-5.2",label:"GPT-5.2 (Latest)"},{value:"gpt-5.1",label:"GPT-5.1"},{value:"gpt-4o",label:"GPT-4o"},{value:"gpt-4o-mini",label:"GPT-4o Mini"}],V=[{value:"claude-opus-4-6-20260205",label:"Claude Opus 4.6 (Latest)"},{value:"claude-sonnet-4-5-20250929",label:"Claude Sonnet 4.5"},{value:"claude-haiku-4-5-20251015",label:"Claude Haiku 4.5"},{value:"claude-3-5-sonnet-20241022",label:"Claude 3.5 Sonnet"}],F=[{value:"gemini-2.5-flash",label:"Gemini 2.5 Flash (Latest GA)"},{value:"gemini-2.5-pro",label:"Gemini 2.5 Pro"},{value:"gemini-3-flash-preview",label:"Gemini 3 Flash (Preview)"},{value:"gemini-2.0-flash",label:"Gemini 2.0 Flash"}];var B=require("child_process"),G=require("util"),u=(0,G.promisify)(B.exec),W=["/usr/local/bin/qmd","/opt/homebrew/bin/qmd",`${process.env.HOME}/.bun/bin/qmd`,`${process.env.HOME}/.local/bin/qmd`,`${process.env.HOME}/.npm-global/bin/qmd`],X=["/usr/local/bin/bun","/opt/homebrew/bin/bun",`${process.env.HOME}/.bun/bin/bun`],me=["/usr/local/bin/npm","/opt/homebrew/bin/npm",`${process.env.HOME}/.nvm/versions/node/*/bin/npm`],C=class{async findQmd(){for(let s of W)try{return await u(`"${s}" --help`,{timeout:5e3}),s}catch(e){continue}try{let{stdout:s}=await u("which qmd",{timeout:5e3}),e=s.trim();if(e)return e}catch(s){}return null}async findBun(){for(let s of X)try{return await u(`"${s}" --version`,{timeout:5e3}),s}catch(e){continue}try{let{stdout:s}=await u("which bun",{timeout:5e3});return s.trim()||null}catch(s){return null}}async findNpm(){try{let{stdout:s}=await u("which npm",{timeout:5e3});return s.trim()||null}catch(s){return null}}async installQmd(s){s({stage:"checking",message:"Checking for package managers..."});let e=await this.findQmd();if(e)return s({stage:"complete",message:`qmd already installed at ${e}`}),e;let t=await this.findBun(),n=await this.findNpm();if(!t&&!n)throw s({stage:"error",message:"Neither bun nor npm found. Please install bun (https://bun.sh) or Node.js first."}),new Error("No package manager found");s({stage:"installing",message:"Installing qmd...",progress:0});try{t?await u(`"${t}" install -g https://github.com/tobi/qmd`,{timeout:3e5}):n&&await u(`"${n}" install -g qmd`,{timeout:3e5}),s({stage:"installing",message:"Verifying installation...",progress:80});let i=await this.findQmd();if(!i)throw new Error("qmd installed but not found in PATH");return s({stage:"complete",message:`qmd installed at ${i}`,progress:100}),i}catch(i){let a=i instanceof Error?i.message:String(i);throw s({stage:"error",message:`Installation failed: ${a}`}),i}}async indexVault(s,e,t,n){n({stage:"indexing",message:`Indexing ${t}...`,progress:0});try{try{await u(`"${s}" collection add "${e}" --name "${t}"`,{timeout:3e5}),n({stage:"indexing",message:"Collection created and indexed",progress:100})}catch(i){if(((i==null?void 0:i.stderr)||(i==null?void 0:i.message)||String(i)).includes("already exists"))n({stage:"indexing",message:"Collection exists, updating...",progress:30}),await u(`"${s}" update`,{timeout:3e5}),n({stage:"indexing",message:"Index updated",progress:100});else throw i}}catch(i){let a=i instanceof Error?i.message:String(i);throw n({stage:"error",message:`Indexing failed: ${a}`}),i}}async generateEmbeddings(s,e){e({stage:"embedding",message:"Generating embeddings (this may take a while)...",progress:0});try{e({stage:"embedding",message:"Downloading models if needed...",progress:10}),await u(`"${s}" embed`,{timeout:18e5}),e({stage:"embedding",message:"Embeddings generated",progress:100})}catch(t){let n=t instanceof Error?t.message:String(t);throw e({stage:"error",message:`Embedding failed: ${n}`}),t}}async fullSetup(s,e,t){let n=await this.installQmd(t);return await this.indexVault(n,s,e,t),await this.generateEmbeddings(n,t),t({stage:"complete",message:"Setup complete! You can now search your vault."}),n}};var b=class extends r.PluginSettingTab{constructor(s,e){super(s,e),this.plugin=e,this.installer=new C}display(){let{containerEl:s}=this;s.empty(),s.createEl("h2",{text:"QMD RAGidian Settings"}),this.addQmdSettings(s),this.addSyncSettings(s),this.addSearchSettings(s),this.addRelatedSettings(s),this.addLLMSettings(s),this.addRAGSettings(s)}addQmdSettings(s){s.createEl("h3",{text:"qmd Configuration"});let e=s.createDiv("qmd-status");this.updateQmdStatus(e),new r.Setting(s).setName("qmd Path").setDesc("Path to the qmd executable (auto-detected if empty)").addText(t=>t.setPlaceholder("Auto-detect").setValue(this.plugin.settings.qmdPath).onChange(async n=>{this.plugin.settings.qmdPath=n,await this.plugin.saveSettings()})).addButton(t=>t.setButtonText("Auto-detect").onClick(async()=>{t.setButtonText("Searching..."),t.setDisabled(!0);let n=await this.installer.findQmd();n?(this.plugin.settings.qmdPath=n,await this.plugin.saveSettings(),new r.Notice(`Found qmd at: ${n}`),this.display()):new r.Notice('qmd not found. Click "Install qmd" to install.'),t.setButtonText("Auto-detect"),t.setDisabled(!1)})),new r.Setting(s).setName("Test Connection").setDesc("Verify qmd is accessible and working").addButton(t=>t.setButtonText("Test").onClick(async()=>{var i;t.setButtonText("Testing..."),t.setDisabled(!0);let n=await this.plugin.qmdClient.testConnection();n.ok?new r.Notice(`qmd connected! ${((i=n.status)==null?void 0:i.totalDocuments)||0} documents indexed.`):new r.Notice(`qmd connection failed: ${n.error}`),t.setButtonText("Test"),t.setDisabled(!1),this.updateQmdStatus(e)})),new r.Setting(s).setName("Install & Setup qmd").setDesc("Automatically install qmd, index your vault, and generate embeddings").addButton(t=>t.setButtonText("One-Click Setup").setCta().onClick(()=>{new R(this.app,this.plugin,this.installer,()=>{this.display()}).open()})),new r.Setting(s).setName("Index Current Vault").setDesc("Add this vault to qmd and generate embeddings").addButton(t=>t.setButtonText("Index Vault").onClick(async()=>{let n=this.plugin.settings.qmdPath||await this.installer.findQmd();if(!n){new r.Notice("qmd not found. Please install qmd first.");return}new Q(this.app,this.plugin,this.installer,n,()=>{this.display()}).open()}))}async updateQmdStatus(s){s.empty();let e=await this.plugin.qmdClient.testConnection();e.ok&&e.status?(s.addClass("qmd-status-ok"),s.removeClass("qmd-status-error"),s.innerHTML=`
        <div class="qmd-status-badge">
          <span class="qmd-status-icon">\u2713</span>
          <span>Connected</span>
        </div>
        <div class="qmd-status-info">
          ${e.status.totalDocuments} documents | 
          ${e.status.totalEmbeddings} embeddings | 
          ${e.status.collections.length} collections
        </div>
      `):(s.addClass("qmd-status-error"),s.removeClass("qmd-status-ok"),s.innerHTML=`
        <div class="qmd-status-badge">
          <span class="qmd-status-icon">\u2717</span>
          <span>Not Connected</span>
        </div>
        <div class="qmd-status-info">
          Click "One-Click Setup" to install and configure qmd
        </div>
      `)}addSyncSettings(s){s.createEl("h3",{text:"Auto Sync"});let e=this.plugin.autoSync.getStatus(),t=s.createDiv("qmd-sync-status");e.lastSync?t.innerHTML=`<span class="qmd-sync-time">Last sync: ${e.lastSync.toLocaleTimeString()}</span>`:t.innerHTML='<span class="qmd-sync-time">Never synced</span>',new r.Setting(s).setName("Sync Mode").setDesc("When to automatically update the search index").addDropdown(n=>n.addOption("off","Off (Manual only)").addOption("on-save","On File Save").addOption("on-startup","On Obsidian Startup").addOption("scheduled","Scheduled Interval").setValue(this.plugin.settings.syncMode).onChange(async i=>{this.plugin.settings.syncMode=i,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.syncMode==="scheduled"&&new r.Setting(s).setName("Sync Interval (minutes)").setDesc("How often to sync in the background").addSlider(n=>n.setLimits(5,60,5).setValue(this.plugin.settings.syncIntervalMinutes).setDynamicTooltip().onChange(async i=>{this.plugin.settings.syncIntervalMinutes=i,await this.plugin.saveSettings()})),new r.Setting(s).setName("Sync Now").setDesc("Manually update index and generate new embeddings").addButton(n=>n.setButtonText("Sync Now").onClick(async()=>{n.setButtonText("Syncing..."),n.setDisabled(!0),await this.plugin.autoSync.manualSync(),n.setButtonText("Sync Now"),n.setDisabled(!1),this.display()}))}addSearchSettings(s){s.createEl("h3",{text:"Search Settings"}),new r.Setting(s).setName("Default Search Mode").setDesc("Default search mode when opening the search panel").addDropdown(e=>e.addOption("search","Keyword (BM25)").addOption("vsearch","Semantic (Vector)").addOption("query","Hybrid (Best)").setValue(this.plugin.settings.defaultSearchMode).onChange(async t=>{this.plugin.settings.defaultSearchMode=t,await this.plugin.saveSettings()})),new r.Setting(s).setName("Default Result Count").setDesc("Number of results to show by default").addSlider(e=>e.setLimits(5,50,5).setValue(this.plugin.settings.defaultLimit).setDynamicTooltip().onChange(async t=>{this.plugin.settings.defaultLimit=t,await this.plugin.saveSettings()})),new r.Setting(s).setName("Minimum Score").setDesc("Filter results below this relevance score (0-1)").addSlider(e=>e.setLimits(0,.9,.1).setValue(this.plugin.settings.minScore).setDynamicTooltip().onChange(async t=>{this.plugin.settings.minScore=t,await this.plugin.saveSettings()}))}addRelatedSettings(s){s.createEl("h3",{text:"Related Documents"}),new r.Setting(s).setName("Enable Auto-Recommend").setDesc("Automatically show related documents when opening a note").addToggle(e=>e.setValue(this.plugin.settings.enableRelated).onChange(async t=>{this.plugin.settings.enableRelated=t,await this.plugin.saveSettings()})),new r.Setting(s).setName("Number of Recommendations").setDesc("How many related documents to show").addSlider(e=>e.setLimits(3,10,1).setValue(this.plugin.settings.relatedLimit).setDynamicTooltip().onChange(async t=>{this.plugin.settings.relatedLimit=t,await this.plugin.saveSettings()})),new r.Setting(s).setName("Cache Duration (minutes)").setDesc("How long to cache related document results").addSlider(e=>e.setLimits(1,30,1).setValue(this.plugin.settings.relatedCacheTTL).setDynamicTooltip().onChange(async t=>{this.plugin.settings.relatedCacheTTL=t,await this.plugin.saveSettings()}))}addLLMSettings(s){s.createEl("h3",{text:"LLM Configuration (for RAG Chat)"}),new r.Setting(s).setName("LLM Provider").setDesc("Select the LLM provider for RAG chat").addDropdown(e=>e.addOption("none","None (Disable RAG)").addOption("openai","OpenAI").addOption("anthropic","Anthropic").addOption("gemini","Google Gemini").addOption("ollama","Ollama (Local)").setValue(this.plugin.settings.llmProvider).onChange(async t=>{this.plugin.settings.llmProvider=t,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.llmProvider==="openai"&&this.addOpenAISettings(s),this.plugin.settings.llmProvider==="anthropic"&&this.addAnthropicSettings(s),this.plugin.settings.llmProvider==="gemini"&&this.addGeminiSettings(s),this.plugin.settings.llmProvider==="ollama"&&this.addOllamaSettings(s)}addOpenAISettings(s){new r.Setting(s).setName("OpenAI API Key").setDesc("Your OpenAI API key").addText(e=>{e.inputEl.type="password",e.setPlaceholder("sk-...").setValue(this.plugin.settings.openaiApiKey).onChange(async t=>{this.plugin.settings.openaiApiKey=t,await this.plugin.saveSettings()})}),new r.Setting(s).setName("Use Custom Model Name").setDesc("Enable to manually specify model name").addToggle(e=>e.setValue(this.plugin.settings.useOpenaiCustomModel).onChange(async t=>{this.plugin.settings.useOpenaiCustomModel=t,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.useOpenaiCustomModel?new r.Setting(s).setName("Custom Model Name").setDesc("Enter the exact model name (e.g., gpt-5.2)").addText(e=>e.setPlaceholder("gpt-5.2").setValue(this.plugin.settings.openaiCustomModel).onChange(async t=>{this.plugin.settings.openaiCustomModel=t,await this.plugin.saveSettings()})):new r.Setting(s).setName("OpenAI Model").setDesc("Select a model").addDropdown(e=>{H.forEach(t=>e.addOption(t.value,t.label)),e.setValue(this.plugin.settings.openaiModel),e.onChange(async t=>{this.plugin.settings.openaiModel=t,await this.plugin.saveSettings()})})}addAnthropicSettings(s){new r.Setting(s).setName("Anthropic API Key").setDesc("Your Anthropic API key").addText(e=>{e.inputEl.type="password",e.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.anthropicApiKey).onChange(async t=>{this.plugin.settings.anthropicApiKey=t,await this.plugin.saveSettings()})}),new r.Setting(s).setName("Use Custom Model Name").setDesc("Enable to manually specify model name").addToggle(e=>e.setValue(this.plugin.settings.useAnthropicCustomModel).onChange(async t=>{this.plugin.settings.useAnthropicCustomModel=t,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.useAnthropicCustomModel?new r.Setting(s).setName("Custom Model Name").setDesc("Enter the exact model name").addText(e=>e.setPlaceholder("claude-opus-4-6-20260205").setValue(this.plugin.settings.anthropicCustomModel).onChange(async t=>{this.plugin.settings.anthropicCustomModel=t,await this.plugin.saveSettings()})):new r.Setting(s).setName("Anthropic Model").setDesc("Select a model").addDropdown(e=>{V.forEach(t=>e.addOption(t.value,t.label)),e.setValue(this.plugin.settings.anthropicModel),e.onChange(async t=>{this.plugin.settings.anthropicModel=t,await this.plugin.saveSettings()})})}addGeminiSettings(s){new r.Setting(s).setName("Gemini API Key").setDesc("Your Google AI API key (from ai.google.dev)").addText(e=>{e.inputEl.type="password",e.setPlaceholder("AIza...").setValue(this.plugin.settings.geminiApiKey).onChange(async t=>{this.plugin.settings.geminiApiKey=t,await this.plugin.saveSettings()})}),new r.Setting(s).setName("Use Custom Model Name").setDesc("Enable to manually specify model name").addToggle(e=>e.setValue(this.plugin.settings.useGeminiCustomModel).onChange(async t=>{this.plugin.settings.useGeminiCustomModel=t,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.useGeminiCustomModel?new r.Setting(s).setName("Custom Model Name").setDesc("Enter the exact model name").addText(e=>e.setPlaceholder("gemini-2.5-flash").setValue(this.plugin.settings.geminiCustomModel).onChange(async t=>{this.plugin.settings.geminiCustomModel=t,await this.plugin.saveSettings()})):new r.Setting(s).setName("Gemini Model").setDesc("Select a model").addDropdown(e=>{F.forEach(t=>e.addOption(t.value,t.label)),e.setValue(this.plugin.settings.geminiModel),e.onChange(async t=>{this.plugin.settings.geminiModel=t,await this.plugin.saveSettings()})})}addOllamaSettings(s){new r.Setting(s).setName("Ollama URL").setDesc("URL of your Ollama instance").addText(e=>e.setPlaceholder("http://localhost:11434").setValue(this.plugin.settings.ollamaUrl).onChange(async t=>{this.plugin.settings.ollamaUrl=t,await this.plugin.saveSettings()})),new r.Setting(s).setName("Ollama Model").setDesc("Model name (e.g., llama3.2, mistral, codellama)").addText(e=>e.setPlaceholder("llama3.2").setValue(this.plugin.settings.ollamaModel).onChange(async t=>{this.plugin.settings.ollamaModel=t,await this.plugin.saveSettings()}))}addRAGSettings(s){this.plugin.settings.llmProvider!=="none"&&(s.createEl("h3",{text:"RAG Settings"}),new r.Setting(s).setName("Context Documents").setDesc("Number of documents to include as context").addSlider(e=>e.setLimits(1,15,1).setValue(this.plugin.settings.ragContextLimit).setDynamicTooltip().onChange(async t=>{this.plugin.settings.ragContextLimit=t,await this.plugin.saveSettings()})),new r.Setting(s).setName("System Prompt").setDesc("Instructions for the AI assistant").addTextArea(e=>e.setPlaceholder("You are a helpful assistant...").setValue(this.plugin.settings.ragSystemPrompt).onChange(async t=>{this.plugin.settings.ragSystemPrompt=t,await this.plugin.saveSettings()})))}},R=class extends r.Modal{constructor(e,t,n,i){super(e);this.progressEl=null;this.isRunning=!1;this.plugin=t,this.installer=n,this.onComplete=i}onOpen(){let{contentEl:e}=this;e.addClass("qmd-setup-modal"),e.createEl("h2",{text:"QMD One-Click Setup"}),e.createEl("p",{text:"This will install qmd, index your current vault, and generate embeddings for semantic search."});let t=e.createDiv("qmd-setup-warning");t.innerHTML=`
      <strong>Note:</strong> This process may take several minutes depending on your vault size.
      <ul>
        <li>Installing qmd (~250MB of models will be downloaded)</li>
        <li>Indexing all markdown files in your vault</li>
        <li>Generating vector embeddings</li>
      </ul>
    `,this.progressEl=e.createDiv("qmd-setup-progress"),this.progressEl.style.display="none";let n=e.createDiv("qmd-setup-buttons"),i=n.createEl("button",{text:"Start Setup",cls:"mod-cta"});i.addEventListener("click",()=>this.runSetup(i)),n.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close())}async runSetup(e){if(this.isRunning)return;this.isRunning=!0,e.disabled=!0,e.textContent="Setting up...",this.progressEl&&(this.progressEl.style.display="block");let t=this.app.vault.adapter.basePath,n=this.app.vault.getName();try{let i=await this.installer.fullSetup(t,n,a=>this.updateProgress(a));this.plugin.settings.qmdPath=i,await this.plugin.saveSettings(),new r.Notice("QMD setup complete! You can now search your vault."),this.onComplete(),this.close()}catch(i){new r.Notice(`Setup failed: ${i instanceof Error?i.message:String(i)}`),e.disabled=!1,e.textContent="Retry Setup",this.isRunning=!1}}updateProgress(e){if(!this.progressEl)return;let t={checking:"\u{1F50D}",installing:"\u{1F4E6}",indexing:"\u{1F4DA}",embedding:"\u{1F9E0}",complete:"\u2705",error:"\u274C"};this.progressEl.innerHTML=`
      <div class="qmd-progress-stage">
        <span class="qmd-progress-icon">${t[e.stage]}</span>
        <span class="qmd-progress-message">${e.message}</span>
      </div>
      ${e.progress!==void 0?`
        <div class="qmd-progress-bar">
          <div class="qmd-progress-fill" style="width: ${e.progress}%"></div>
        </div>
      `:""}
    `}onClose(){this.contentEl.empty()}},Q=class extends r.Modal{constructor(e,t,n,i,a){super(e);this.progressEl=null;this.plugin=t,this.installer=n,this.qmdPath=i,this.onComplete=a}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Index Vault"});let t=this.app.vault.adapter.basePath,n=this.app.vault.getName();e.createEl("p",{text:`This will index "${n}" and generate embeddings.`}),this.progressEl=e.createDiv("qmd-setup-progress");let i=e.createDiv("qmd-setup-buttons"),a=i.createEl("button",{text:"Start Indexing",cls:"mod-cta"});a.addEventListener("click",async()=>{a.disabled=!0,a.textContent="Indexing...";try{await this.installer.indexVault(this.qmdPath,t,n,l=>{this.progressEl&&(this.progressEl.textContent=l.message)}),await this.installer.generateEmbeddings(this.qmdPath,l=>{this.progressEl&&(this.progressEl.textContent=l.message)}),new r.Notice("Indexing complete!"),this.onComplete(),this.close()}catch(l){new r.Notice(`Indexing failed: ${l instanceof Error?l.message:String(l)}`),a.disabled=!1,a.textContent="Retry"}}),i.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close())}onClose(){this.contentEl.empty()}};var M=class extends v.Plugin{constructor(){super(...arguments);this.settings=A;this.llmProvider=null}async onload(){await this.loadSettings(),this.qmdClient=new y(this.settings.qmdPath),this.llmProvider=L(this.settings),this.relatedCache=new g(this.settings.relatedCacheTTL*60*1e3),this.autoSync=new f(this.app,this.settings.qmdPath,this.settings.syncMode,this.settings.syncIntervalMinutes),this.debouncedUpdateRelated=S(e=>this.updateRelatedForFile(e),this.settings.relatedDebounceMs),this.registerView(p,e=>new w(e,this)),this.addRibbonIcon("search","QMD Search",()=>{this.activateView()}),this.addCommand({id:"open-qmd-search",name:"Open QMD Search",callback:()=>this.activateView()}),this.addCommand({id:"search-selection",name:"Search Selection in QMD",editorCallback:async e=>{let t=e.getSelection();if(t){await this.activateView();let n=this.getQmdView();n&&(n.searchInput.value=t,n.executeSearch())}}}),this.addCommand({id:"sync-now",name:"Sync Index Now",callback:()=>this.autoSync.manualSync()}),this.addSettingTab(new b(this.app,this)),this.registerEvent(this.app.vault.on("modify",e=>this.autoSync.onFileChange(e))),this.registerEvent(this.app.vault.on("create",e=>this.autoSync.onFileChange(e))),this.registerEvent(this.app.vault.on("delete",e=>this.autoSync.onFileDelete(e))),this.registerEvent(this.app.vault.on("rename",e=>this.autoSync.onFileChange(e))),this.settings.enableRelated&&(this.registerEvent(this.app.workspace.on("file-open",e=>{e instanceof v.TFile&&e.extension==="md"&&this.debouncedUpdateRelated(e)})),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{let e=this.app.workspace.getActiveFile();e instanceof v.TFile&&e.extension==="md"&&this.debouncedUpdateRelated(e)}))),this.autoSync.start()}async onunload(){this.autoSync.destroy(),this.relatedCache.destroy(),this.app.workspace.detachLeavesOfType(p)}async loadSettings(){this.settings=Object.assign({},A,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.qmdClient.setPath(this.settings.qmdPath),this.llmProvider=L(this.settings),this.relatedCache=new g(this.settings.relatedCacheTTL*60*1e3),this.autoSync.setQmdPath(this.settings.qmdPath),this.autoSync.setMode(this.settings.syncMode),this.autoSync.setInterval(this.settings.syncIntervalMinutes)}async activateView(){let{workspace:e}=this.app,t=e.getLeavesOfType(p)[0];if(!t){let n=e.getRightLeaf(!1);n&&(t=n,await t.setViewState({type:p,active:!0}))}t&&e.revealLeaf(t)}getQmdView(){let e=this.app.workspace.getLeavesOfType(p);return e.length>0?e[0].view:null}async updateRelatedForFile(e){let t=this.getQmdView();t&&await t.updateRelatedDocuments(e)}async chat(e,t,n){if(!this.llmProvider)throw new Error("LLM provider not configured. Go to Settings > QMD RAGidian.");let a=[{role:"system",content:`${this.settings.ragSystemPrompt.replace("{context}",t)}

Context:
${t}`},{role:"user",content:e}];return await this.llmProvider.chat(a)}};
