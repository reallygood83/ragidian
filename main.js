/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var S=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var Q=(r,s)=>{for(var e in s)S(r,e,{get:s[e],enumerable:!0})},V=(r,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let a of O(s))!N.call(r,a)&&a!==e&&S(r,a,{get:()=>s[a],enumerable:!(t=I(s,a))||t.enumerable});return r};var G=r=>V(S({},"__esModule",{value:!0}),r);var H={};Q(H,{default:()=>C});module.exports=G(H);var m=require("obsidian");var L=require("child_process"),E=require("util"),w=(0,E.promisify)(L.exec),g=class{constructor(s){this.qmdPath=s}setPath(s){this.qmdPath=s}async search(s,e={}){let t=this.buildArgs("search",s,e);return{...await this.execute(t),mode:"search"}}async vsearch(s,e={}){let t=this.buildArgs("vsearch",s,e);return{...await this.execute(t),mode:"vsearch"}}async query(s,e={}){let t=this.buildArgs("query",s,e);return{...await this.execute(t),mode:"query"}}async get(s){let e=this.escapeShellArg(s),{stdout:t}=await w(`${this.qmdPath} get ${e} --json`,{maxBuffer:10*1024*1024});return JSON.parse(t)}async status(){let{stdout:s}=await w(`${this.qmdPath} status --json`,{maxBuffer:1048576});return JSON.parse(s)}async testConnection(){try{return{ok:!0,status:await this.status()}}catch(s){return{ok:!1,error:s instanceof Error?s.message:String(s)}}}async getCollections(){try{return(await this.status()).collections.map(e=>e.name)}catch(s){return[]}}buildArgs(s,e,t){let a=this.escapeShellArg(e),i=[s,a,"--json"];return t.collection&&i.push("-c",t.collection),t.limit&&i.push("-n",String(t.limit)),t.minScore&&i.push("--min-score",String(t.minScore)),t.full&&i.push("--full"),i.join(" ")}async execute(s){try{let{stdout:e,stderr:t}=await w(`${this.qmdPath} ${s}`,{maxBuffer:10485760,timeout:3e4});t&&console.warn("[QMD]",t);let a=JSON.parse(e);return this.normalizeResponse(a)}catch(e){throw this.handleError(e)}}normalizeResponse(s){return{results:(s.results||s.documents||[]).map(t=>{var a;return{docid:t.docid||t.id||"",path:t.path||t.file||"",absolutePath:t.absolutePath||t.absolute_path||t.path||"",title:t.title||this.extractTitleFromPath(t.path||""),score:typeof t.score=="number"?t.score:parseFloat(t.score)||0,snippet:t.snippet||((a=t.content)==null?void 0:a.substring(0,200))||"",context:t.context||void 0,collection:t.collection||"default"}}),query:s.query||"",mode:s.mode||"search",elapsed:s.elapsed||0}}extractTitleFromPath(s){return(s.split("/").pop()||s).replace(/\.md$/,"")}escapeShellArg(s){return`"${s.replace(/"/g,'\\"')}"`}handleError(s){var t;let e=s;return e.code==="ENOENT"?{type:"connection",message:"qmd not found at the specified path",details:`Path: ${this.qmdPath}`}:e.killed?{type:"timeout",message:"Search timed out",details:"Try a simpler query or reduce result count"}:(t=e.message)!=null&&t.includes("JSON")?{type:"parse",message:"Failed to parse qmd response",details:e.message}:{type:"unknown",message:e.message||"Unknown error",details:String(s)}}};var p=class{constructor(s=300*1e3){this.ttlMs=s;this.cache=new Map;this.cleanupInterval=null;this.cleanupInterval=setInterval(()=>this.cleanup(),60*1e3)}get(s){let e=this.cache.get(s);return e?Date.now()>e.expires?(this.cache.delete(s),null):e.data:null}set(s,e,t){this.cache.set(s,{data:e,expires:Date.now()+(t!=null?t:this.ttlMs)})}has(s){return this.get(s)!==null}delete(s){return this.cache.delete(s)}clear(){this.cache.clear()}size(){return this.cache.size}cleanup(){let s=Date.now();for(let[e,t]of this.cache)s>t.expires&&this.cache.delete(e)}touch(s){let e=this.cache.get(s);return e?(e.expires=Date.now()+this.ttlMs,!0):!1}destroy(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.cache.clear()}};var M=class{constructor(s,e){this.apiKey=s;this.model=e}async chat(s){let e=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({model:this.model,messages:s,max_tokens:2048})});if(!e.ok){let a=await e.text();throw new Error(`OpenAI API error: ${a}`)}return(await e.json()).choices[0].message.content}},b=class{constructor(s,e){this.apiKey=s;this.model=e}async chat(s){let e=s.find(n=>n.role==="system"),t=s.filter(n=>n.role!=="system"),a=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:this.model,max_tokens:2048,system:e==null?void 0:e.content,messages:t.map(n=>({role:n.role,content:n.content}))})});if(!a.ok){let n=await a.text();throw new Error(`Anthropic API error: ${n}`)}return(await a.json()).content[0].text}},x=class{constructor(s,e){this.apiKey=s;this.model=e}async chat(s){let e=s.find(l=>l.role==="system"),i={contents:s.filter(l=>l.role!=="system").map(l=>({role:l.role==="assistant"?"model":"user",parts:[{text:l.content}]}))};e&&(i.systemInstruction={parts:[{text:e.content}]}),i.generationConfig={maxOutputTokens:2048,temperature:.7};let n=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${this.model}:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!n.ok){let l=await n.text();throw new Error(`Gemini API error: ${l}`)}let c=await n.json();if(!c.candidates||c.candidates.length===0)throw new Error("Gemini returned no response");return c.candidates[0].content.parts[0].text}},P=class{constructor(s,e){this.baseUrl=s;this.model=e}async chat(s){let e=await fetch(`${this.baseUrl}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:this.model,messages:s,stream:!1})});if(!e.ok){let a=await e.text();throw new Error(`Ollama API error: ${a}`)}return(await e.json()).message.content}};function T(r){switch(r.llmProvider){case"openai":{if(!r.openaiApiKey)return null;let s=r.useOpenaiCustomModel&&r.openaiCustomModel?r.openaiCustomModel:r.openaiModel;return new M(r.openaiApiKey,s)}case"anthropic":{if(!r.anthropicApiKey)return null;let s=r.useAnthropicCustomModel&&r.anthropicCustomModel?r.anthropicCustomModel:r.anthropicModel;return new b(r.anthropicApiKey,s)}case"gemini":{if(!r.geminiApiKey)return null;let s=r.useGeminiCustomModel&&r.geminiCustomModel?r.geminiCustomModel:r.geminiModel;return new x(r.geminiApiKey,s)}case"ollama":return new P(r.ollamaUrl,r.ollamaModel);default:return null}}var d=require("obsidian");function v(r,s){let e=null;return function(...t){e&&clearTimeout(e),e=setTimeout(()=>{r.apply(this,t),e=null},s)}}var u="qmd-sidebar",y=class extends d.ItemView{constructor(e,t){super(e);this.searchInput=null;this.resultsContainer=null;this.relatedContainer=null;this.chatContainer=null;this.chatInput=null;this.chatMessages=[];this.currentMode="query";this.isSearching=!1;this.currentFile=null;this.plugin=t,this.currentMode=t.settings.defaultSearchMode}getViewType(){return u}getDisplayText(){return"QMD Search"}getIcon(){return"search"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("qmd-sidebar"),this.renderHeader(e),this.renderSearchPanel(e),this.renderResultsPanel(e),this.renderChatPanel(e),this.renderRelatedPanel(e)}async onClose(){this.searchInput=null,this.resultsContainer=null,this.relatedContainer=null,this.chatContainer=null,this.chatInput=null}renderHeader(e){let t=e.createDiv("qmd-header");t.createEl("h4",{text:"QMD Search"}).addClass("qmd-title");let i=t.createEl("button",{cls:"qmd-settings-btn clickable-icon"});(0,d.setIcon)(i,"settings"),i.addEventListener("click",()=>{this.app.setting.open(),this.app.setting.openTabById("qmd-ragidian")})}renderSearchPanel(e){let t=e.createDiv("qmd-search-panel"),a=t.createDiv("qmd-input-wrapper");this.searchInput=a.createEl("input",{type:"text",placeholder:"Search your notes...",cls:"qmd-search-input"});let i=a.createEl("button",{cls:"qmd-search-btn clickable-icon"});(0,d.setIcon)(i,"search"),i.addEventListener("click",()=>this.executeSearch()),this.searchInput.addEventListener("keydown",h=>{h.key==="Enter"&&this.executeSearch()});let n=v(()=>this.executeSearch(),300);this.searchInput.addEventListener("input",n);let c=t.createDiv("qmd-mode-selector");this.renderModeButtons(c);let l=t.createDiv("qmd-collection-selector");this.renderCollectionDropdown(l)}renderModeButtons(e){[{id:"search",label:"Keyword",icon:"file-text"},{id:"vsearch",label:"Semantic",icon:"brain"},{id:"query",label:"Hybrid",icon:"sparkles"}].forEach(a=>{let i=e.createEl("button",{text:a.label,cls:`qmd-mode-btn ${a.id===this.currentMode?"active":""}`});i.dataset.mode=a.id,i.addEventListener("click",()=>{var n;e.querySelectorAll(".qmd-mode-btn").forEach(c=>c.removeClass("active")),i.addClass("active"),this.currentMode=a.id,(n=this.searchInput)!=null&&n.value&&this.executeSearch()})})}async renderCollectionDropdown(e){let t=e.createEl("span",{text:"Collection: ",cls:"qmd-collection-label"}),a=e.createEl("select",{cls:"qmd-collection-select"});a.createEl("option",{value:"",text:"All"});try{(await this.plugin.qmdClient.getCollections()).forEach(n=>{a.createEl("option",{value:n,text:n})})}catch(i){console.warn("Failed to load collections:",i)}}renderResultsPanel(e){let t=e.createDiv("qmd-results-panel"),a=t.createDiv("qmd-results-header");a.createEl("span",{text:"Results",cls:"qmd-results-title"});let i=a.createEl("button",{cls:"qmd-refresh-btn clickable-icon"});(0,d.setIcon)(i,"refresh-cw"),i.addEventListener("click",()=>this.executeSearch()),this.resultsContainer=t.createDiv("qmd-results-list"),this.resultsContainer.createEl("div",{text:"Enter a search query above",cls:"qmd-results-empty"})}renderChatPanel(e){if(this.plugin.settings.llmProvider==="none")return;let t=e.createDiv("qmd-chat-panel"),a=t.createDiv("qmd-chat-header");a.createEl("span",{text:"RAG Chat",cls:"qmd-chat-title"});let i=a.createEl("button",{cls:"qmd-collapse-btn clickable-icon"});(0,d.setIcon)(i,"chevron-down"),i.addEventListener("click",()=>{t.toggleClass("collapsed",!t.hasClass("collapsed")),(0,d.setIcon)(i,t.hasClass("collapsed")?"chevron-right":"chevron-down")}),this.chatContainer=t.createDiv("qmd-chat-messages");let n=t.createDiv("qmd-chat-input-wrapper");this.chatInput=n.createEl("textarea",{placeholder:"Ask a question about your notes...",cls:"qmd-chat-input"});let c=n.createEl("button",{cls:"qmd-chat-send clickable-icon"});(0,d.setIcon)(c,"send"),c.addEventListener("click",()=>this.sendChatMessage()),this.chatInput.addEventListener("keydown",l=>{l.key==="Enter"&&!l.shiftKey&&(l.preventDefault(),this.sendChatMessage())})}renderRelatedPanel(e){let t=e.createDiv("qmd-related-panel"),a=t.createDiv("qmd-related-header");a.createEl("span",{text:"Related Documents",cls:"qmd-related-title"});let i=a.createEl("button",{cls:"qmd-collapse-btn clickable-icon"});(0,d.setIcon)(i,"chevron-down"),i.addEventListener("click",()=>{t.toggleClass("collapsed",!t.hasClass("collapsed")),(0,d.setIcon)(i,t.hasClass("collapsed")?"chevron-right":"chevron-down")}),this.relatedContainer=t.createDiv("qmd-related-list"),this.relatedContainer.createEl("div",{text:"Open a note to see related documents",cls:"qmd-related-empty"})}async executeSearch(){var t,a;let e=(a=(t=this.searchInput)==null?void 0:t.value)==null?void 0:a.trim();if(!(!e||this.isSearching)){this.isSearching=!0,this.showSearchLoading();try{let i=this.containerEl.querySelector(".qmd-collection-select"),n=(i==null?void 0:i.value)||void 0,c,l={collection:n,limit:this.plugin.settings.defaultLimit,minScore:this.plugin.settings.minScore};switch(this.currentMode){case"search":c=await this.plugin.qmdClient.search(e,l);break;case"vsearch":c=await this.plugin.qmdClient.vsearch(e,l);break;case"query":default:c=await this.plugin.qmdClient.query(e,l);break}this.renderResults(c)}catch(i){this.showSearchError(i instanceof Error?i.message:String(i))}finally{this.isSearching=!1}}}showSearchLoading(){if(!this.resultsContainer)return;this.resultsContainer.empty(),this.resultsContainer.createDiv("qmd-loading").createEl("span",{text:"Searching...",cls:"qmd-loading-text"})}showSearchError(e){if(!this.resultsContainer)return;this.resultsContainer.empty();let t=this.resultsContainer.createDiv("qmd-error");(0,d.setIcon)(t.createSpan(),"alert-circle"),t.createEl("span",{text:e,cls:"qmd-error-text"})}renderResults(e){if(!this.resultsContainer)return;if(this.resultsContainer.empty(),e.results.length===0){this.resultsContainer.createEl("div",{text:"No results found",cls:"qmd-results-empty"});return}this.resultsContainer.createDiv("qmd-results-count").createEl("span",{text:`${e.results.length} results (${e.elapsed}ms)`}),e.results.forEach(a=>{this.renderResultItem(this.resultsContainer,a)})}renderResultItem(e,t){let a=e.createDiv("qmd-result-card");a.addEventListener("click",l=>{let h=l.metaKey||l.ctrlKey;this.openDocument(t,h)});let i=a.createDiv("qmd-result-header");(0,d.setIcon)(i.createSpan("qmd-result-icon"),"file-text"),i.createEl("span",{text:t.title,cls:"qmd-result-title"});let n=Math.round(t.score*100),c=n>=70?"high":n>=40?"medium":"low";i.createEl("span",{text:`${n}%`,cls:`qmd-result-score qmd-score-${c}`}),t.snippet&&a.createEl("div",{text:t.snippet.substring(0,150)+(t.snippet.length>150?"...":""),cls:"qmd-result-snippet"}),t.context&&a.createEl("div",{text:t.context,cls:"qmd-result-context"})}openDocument(e,t){let a=e.path;t?this.app.workspace.openLinkText(a,"","tab"):this.app.workspace.openLinkText(a,"",!1)}async updateRelatedDocuments(e){if(!this.plugin.settings.enableRelated||!this.relatedContainer||e===this.currentFile)return;this.currentFile=e;let t=e.path,a=this.plugin.relatedCache.get(t);if(a){this.renderRelatedResults(a);return}this.relatedContainer.empty(),this.relatedContainer.createEl("div",{text:"Loading...",cls:"qmd-related-loading"});try{let i=await this.app.vault.cachedRead(e),n=`${e.basename} ${i.substring(0,300)}`,c=await this.plugin.qmdClient.vsearch(n,{limit:this.plugin.settings.relatedLimit+1,minScore:.3}),l=c.results.filter(k=>k.path!==e.path),h={...c,results:l.slice(0,this.plugin.settings.relatedLimit)};this.plugin.relatedCache.set(t,h),this.renderRelatedResults(h)}catch(i){this.relatedContainer.empty(),this.relatedContainer.createEl("div",{text:"Failed to load related documents",cls:"qmd-related-error"})}}renderRelatedResults(e){if(this.relatedContainer){if(this.relatedContainer.empty(),e.results.length===0){this.relatedContainer.createEl("div",{text:"No related documents found",cls:"qmd-related-empty"});return}e.results.forEach(t=>{let a=this.relatedContainer.createDiv("qmd-related-item");a.addEventListener("click",()=>this.openDocument(t,!1)),a.createEl("span",{text:t.title,cls:"qmd-related-title"});let i=Math.round(t.score*100);a.createEl("span",{text:`${i}%`,cls:"qmd-related-score"})})}}async sendChatMessage(){var t,a;let e=(a=(t=this.chatInput)==null?void 0:t.value)==null?void 0:a.trim();if(!(!e||!this.chatContainer)){this.chatInput.value="",this.addChatMessage({role:"user",content:e}),this.addChatMessage({role:"assistant",content:"Thinking..."});try{let i=await this.plugin.qmdClient.query(e,{limit:this.plugin.settings.ragContextLimit,minScore:.2}),n=i.results.map(l=>`### ${l.title}
${l.snippet}`).join(`

`),c=await this.plugin.chat(e,n,i.results);this.chatMessages.pop(),this.addChatMessage({role:"assistant",content:c,sources:i.results})}catch(i){this.chatMessages.pop(),this.addChatMessage({role:"assistant",content:`Error: ${i instanceof Error?i.message:String(i)}`})}}}addChatMessage(e){if(!this.chatContainer)return;if(this.chatMessages.push(e),e.content==="Thinking..."){let n=this.chatContainer.querySelector(".qmd-chat-thinking");n&&n.remove()}let t=this.chatContainer.createDiv(`qmd-chat-message qmd-chat-${e.role}`),a=e.role==="user"?"user":"bot";if((0,d.setIcon)(t.createSpan("qmd-chat-icon"),a),t.createDiv("qmd-chat-content").setText(e.content),e.content==="Thinking..."&&t.addClass("qmd-chat-thinking"),e.sources&&e.sources.length>0){let n=t.createDiv("qmd-chat-sources");n.createEl("span",{text:"Sources: ",cls:"qmd-chat-sources-label"}),e.sources.forEach(c=>{n.createEl("a",{text:c.title,cls:"qmd-chat-source-link"}).addEventListener("click",h=>{h.preventDefault(),this.openDocument(c,!1)})})}this.chatContainer.scrollTop=this.chatContainer.scrollHeight}};var o=require("obsidian");var q={qmdPath:"/usr/local/bin/qmd",defaultSearchMode:"query",defaultLimit:10,minScore:.3,enableRelated:!0,relatedLimit:5,relatedCacheTTL:5,relatedDebounceMs:2e3,llmProvider:"none",openaiApiKey:"",openaiModel:"gpt-5.2",openaiCustomModel:"",useOpenaiCustomModel:!1,anthropicApiKey:"",anthropicModel:"claude-opus-4-6-20260205",anthropicCustomModel:"",useAnthropicCustomModel:!1,geminiApiKey:"",geminiModel:"gemini-2.5-flash",geminiCustomModel:"",useGeminiCustomModel:!1,ollamaUrl:"http://localhost:11434",ollamaModel:"llama3.2",ragContextLimit:5,ragSystemPrompt:`You are a helpful assistant that answers questions based on the user's notes.
Use the provided documents as context. If the answer isn't in the context, say so.
Always cite your sources using [[document-name]] format.`},D=[{value:"gpt-5.2",label:"GPT-5.2 (Latest)"},{value:"gpt-5.1",label:"GPT-5.1"},{value:"gpt-4o",label:"GPT-4o"},{value:"gpt-4o-mini",label:"GPT-4o Mini"}],A=[{value:"claude-opus-4-6-20260205",label:"Claude Opus 4.6 (Latest)"},{value:"claude-sonnet-4-5-20250929",label:"Claude Sonnet 4.5"},{value:"claude-haiku-4-5-20251015",label:"Claude Haiku 4.5"},{value:"claude-3-5-sonnet-20241022",label:"Claude 3.5 Sonnet"}],R=[{value:"gemini-2.5-flash",label:"Gemini 2.5 Flash (Latest GA)"},{value:"gemini-2.5-pro",label:"Gemini 2.5 Pro"},{value:"gemini-3-flash-preview",label:"Gemini 3 Flash (Preview)"},{value:"gemini-2.0-flash",label:"Gemini 2.0 Flash"}];var f=class extends o.PluginSettingTab{constructor(s,e){super(s,e),this.plugin=e}display(){let{containerEl:s}=this;s.empty(),s.createEl("h2",{text:"QMD RAGidian Settings"}),this.addQmdSettings(s),this.addSearchSettings(s),this.addRelatedSettings(s),this.addLLMSettings(s),this.addRAGSettings(s)}addQmdSettings(s){s.createEl("h3",{text:"qmd Configuration"}),new o.Setting(s).setName("qmd Path").setDesc("Path to the qmd executable").addText(e=>e.setPlaceholder("/usr/local/bin/qmd").setValue(this.plugin.settings.qmdPath).onChange(async t=>{this.plugin.settings.qmdPath=t,await this.plugin.saveSettings()})),new o.Setting(s).setName("Test Connection").setDesc("Verify qmd is accessible and working").addButton(e=>e.setButtonText("Test").onClick(async()=>{var a;e.setButtonText("Testing..."),e.setDisabled(!0);let t=await this.plugin.qmdClient.testConnection();t.ok?new o.Notice(`qmd connected! ${((a=t.status)==null?void 0:a.totalDocuments)||0} documents indexed.`):new o.Notice(`qmd connection failed: ${t.error}`),e.setButtonText("Test"),e.setDisabled(!1)}))}addSearchSettings(s){s.createEl("h3",{text:"Search Settings"}),new o.Setting(s).setName("Default Search Mode").setDesc("Default search mode when opening the search panel").addDropdown(e=>e.addOption("search","Keyword (BM25)").addOption("vsearch","Semantic (Vector)").addOption("query","Hybrid (Best)").setValue(this.plugin.settings.defaultSearchMode).onChange(async t=>{this.plugin.settings.defaultSearchMode=t,await this.plugin.saveSettings()})),new o.Setting(s).setName("Default Result Count").setDesc("Number of results to show by default").addSlider(e=>e.setLimits(5,50,5).setValue(this.plugin.settings.defaultLimit).setDynamicTooltip().onChange(async t=>{this.plugin.settings.defaultLimit=t,await this.plugin.saveSettings()})),new o.Setting(s).setName("Minimum Score").setDesc("Filter results below this relevance score (0-1)").addSlider(e=>e.setLimits(0,.9,.1).setValue(this.plugin.settings.minScore).setDynamicTooltip().onChange(async t=>{this.plugin.settings.minScore=t,await this.plugin.saveSettings()}))}addRelatedSettings(s){s.createEl("h3",{text:"Related Documents"}),new o.Setting(s).setName("Enable Auto-Recommend").setDesc("Automatically show related documents when opening a note").addToggle(e=>e.setValue(this.plugin.settings.enableRelated).onChange(async t=>{this.plugin.settings.enableRelated=t,await this.plugin.saveSettings()})),new o.Setting(s).setName("Number of Recommendations").setDesc("How many related documents to show").addSlider(e=>e.setLimits(3,10,1).setValue(this.plugin.settings.relatedLimit).setDynamicTooltip().onChange(async t=>{this.plugin.settings.relatedLimit=t,await this.plugin.saveSettings()})),new o.Setting(s).setName("Cache Duration (minutes)").setDesc("How long to cache related document results").addSlider(e=>e.setLimits(1,30,1).setValue(this.plugin.settings.relatedCacheTTL).setDynamicTooltip().onChange(async t=>{this.plugin.settings.relatedCacheTTL=t,await this.plugin.saveSettings()}))}addLLMSettings(s){s.createEl("h3",{text:"LLM Configuration (for RAG Chat)"}),new o.Setting(s).setName("LLM Provider").setDesc("Select the LLM provider for RAG chat").addDropdown(e=>e.addOption("none","None (Disable RAG)").addOption("openai","OpenAI").addOption("anthropic","Anthropic").addOption("gemini","Google Gemini").addOption("ollama","Ollama (Local)").setValue(this.plugin.settings.llmProvider).onChange(async t=>{this.plugin.settings.llmProvider=t,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.llmProvider==="openai"&&this.addOpenAISettings(s),this.plugin.settings.llmProvider==="anthropic"&&this.addAnthropicSettings(s),this.plugin.settings.llmProvider==="gemini"&&this.addGeminiSettings(s),this.plugin.settings.llmProvider==="ollama"&&this.addOllamaSettings(s)}addOpenAISettings(s){new o.Setting(s).setName("OpenAI API Key").setDesc("Your OpenAI API key").addText(e=>e.setPlaceholder("sk-...").setValue(this.plugin.settings.openaiApiKey).onChange(async t=>{this.plugin.settings.openaiApiKey=t,await this.plugin.saveSettings()})),new o.Setting(s).setName("Use Custom Model Name").setDesc("Enable to manually specify model name").addToggle(e=>e.setValue(this.plugin.settings.useOpenaiCustomModel).onChange(async t=>{this.plugin.settings.useOpenaiCustomModel=t,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.useOpenaiCustomModel?new o.Setting(s).setName("Custom Model Name").setDesc("Enter the exact model name (e.g., gpt-5.2)").addText(e=>e.setPlaceholder("gpt-5.2").setValue(this.plugin.settings.openaiCustomModel).onChange(async t=>{this.plugin.settings.openaiCustomModel=t,await this.plugin.saveSettings()})):new o.Setting(s).setName("OpenAI Model").setDesc("Select a model").addDropdown(e=>{D.forEach(t=>e.addOption(t.value,t.label)),e.setValue(this.plugin.settings.openaiModel),e.onChange(async t=>{this.plugin.settings.openaiModel=t,await this.plugin.saveSettings()})})}addAnthropicSettings(s){new o.Setting(s).setName("Anthropic API Key").setDesc("Your Anthropic API key").addText(e=>e.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.anthropicApiKey).onChange(async t=>{this.plugin.settings.anthropicApiKey=t,await this.plugin.saveSettings()})),new o.Setting(s).setName("Use Custom Model Name").setDesc("Enable to manually specify model name").addToggle(e=>e.setValue(this.plugin.settings.useAnthropicCustomModel).onChange(async t=>{this.plugin.settings.useAnthropicCustomModel=t,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.useAnthropicCustomModel?new o.Setting(s).setName("Custom Model Name").setDesc("Enter the exact model name").addText(e=>e.setPlaceholder("claude-opus-4-6-20260205").setValue(this.plugin.settings.anthropicCustomModel).onChange(async t=>{this.plugin.settings.anthropicCustomModel=t,await this.plugin.saveSettings()})):new o.Setting(s).setName("Anthropic Model").setDesc("Select a model").addDropdown(e=>{A.forEach(t=>e.addOption(t.value,t.label)),e.setValue(this.plugin.settings.anthropicModel),e.onChange(async t=>{this.plugin.settings.anthropicModel=t,await this.plugin.saveSettings()})})}addGeminiSettings(s){new o.Setting(s).setName("Gemini API Key").setDesc("Your Google AI API key (from ai.google.dev)").addText(e=>e.setPlaceholder("AIza...").setValue(this.plugin.settings.geminiApiKey).onChange(async t=>{this.plugin.settings.geminiApiKey=t,await this.plugin.saveSettings()})),new o.Setting(s).setName("Use Custom Model Name").setDesc("Enable to manually specify model name").addToggle(e=>e.setValue(this.plugin.settings.useGeminiCustomModel).onChange(async t=>{this.plugin.settings.useGeminiCustomModel=t,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.useGeminiCustomModel?new o.Setting(s).setName("Custom Model Name").setDesc("Enter the exact model name").addText(e=>e.setPlaceholder("gemini-2.5-flash").setValue(this.plugin.settings.geminiCustomModel).onChange(async t=>{this.plugin.settings.geminiCustomModel=t,await this.plugin.saveSettings()})):new o.Setting(s).setName("Gemini Model").setDesc("Select a model").addDropdown(e=>{R.forEach(t=>e.addOption(t.value,t.label)),e.setValue(this.plugin.settings.geminiModel),e.onChange(async t=>{this.plugin.settings.geminiModel=t,await this.plugin.saveSettings()})})}addOllamaSettings(s){new o.Setting(s).setName("Ollama URL").setDesc("URL of your Ollama instance").addText(e=>e.setPlaceholder("http://localhost:11434").setValue(this.plugin.settings.ollamaUrl).onChange(async t=>{this.plugin.settings.ollamaUrl=t,await this.plugin.saveSettings()})),new o.Setting(s).setName("Ollama Model").setDesc("Model name (e.g., llama3.2, mistral, codellama)").addText(e=>e.setPlaceholder("llama3.2").setValue(this.plugin.settings.ollamaModel).onChange(async t=>{this.plugin.settings.ollamaModel=t,await this.plugin.saveSettings()}))}addRAGSettings(s){this.plugin.settings.llmProvider!=="none"&&(s.createEl("h3",{text:"RAG Settings"}),new o.Setting(s).setName("Context Documents").setDesc("Number of documents to include as context").addSlider(e=>e.setLimits(1,15,1).setValue(this.plugin.settings.ragContextLimit).setDynamicTooltip().onChange(async t=>{this.plugin.settings.ragContextLimit=t,await this.plugin.saveSettings()})),new o.Setting(s).setName("System Prompt").setDesc("Instructions for the AI assistant").addTextArea(e=>e.setPlaceholder("You are a helpful assistant...").setValue(this.plugin.settings.ragSystemPrompt).onChange(async t=>{this.plugin.settings.ragSystemPrompt=t,await this.plugin.saveSettings()})))}};var C=class extends m.Plugin{constructor(){super(...arguments);this.settings=q;this.llmProvider=null}async onload(){await this.loadSettings(),this.qmdClient=new g(this.settings.qmdPath),this.llmProvider=T(this.settings),this.relatedCache=new p(this.settings.relatedCacheTTL*60*1e3),this.debouncedUpdateRelated=v(e=>this.updateRelatedForFile(e),this.settings.relatedDebounceMs),this.registerView(u,e=>new y(e,this)),this.addRibbonIcon("search","QMD Search",()=>{this.activateView()}),this.addCommand({id:"open-qmd-search",name:"Open QMD Search",callback:()=>this.activateView()}),this.addCommand({id:"search-selection",name:"Search Selection in QMD",editorCallback:async e=>{let t=e.getSelection();if(t){await this.activateView();let a=this.getQmdView();a&&(a.searchInput.value=t,a.executeSearch())}}}),this.addSettingTab(new f(this.app,this)),this.settings.enableRelated&&(this.registerEvent(this.app.workspace.on("file-open",e=>{e instanceof m.TFile&&e.extension==="md"&&this.debouncedUpdateRelated(e)})),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{let e=this.app.workspace.getActiveFile();e instanceof m.TFile&&e.extension==="md"&&this.debouncedUpdateRelated(e)})))}async onunload(){this.relatedCache.destroy(),this.app.workspace.detachLeavesOfType(u)}async loadSettings(){this.settings=Object.assign({},q,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.qmdClient.setPath(this.settings.qmdPath),this.llmProvider=T(this.settings),this.relatedCache=new p(this.settings.relatedCacheTTL*60*1e3)}async activateView(){let{workspace:e}=this.app,t=e.getLeavesOfType(u)[0];if(!t){let a=e.getRightLeaf(!1);a&&(t=a,await t.setViewState({type:u,active:!0}))}t&&e.revealLeaf(t)}getQmdView(){let e=this.app.workspace.getLeavesOfType(u);return e.length>0?e[0].view:null}async updateRelatedForFile(e){let t=this.getQmdView();t&&await t.updateRelatedDocuments(e)}async chat(e,t,a){if(!this.llmProvider)throw new Error("LLM provider not configured. Go to Settings > QMD RAGidian.");let n=[{role:"system",content:`${this.settings.ragSystemPrompt.replace("{context}",t)}

Context:
${t}`},{role:"user",content:e}];return await this.llmProvider.chat(n)}};
